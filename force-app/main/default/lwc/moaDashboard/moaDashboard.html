<template>
    <div class="moa-wrapper">

        <!-- Trial Expiry Banner -->
        <template if:true={isTrialExpired}>
            <div class="moa-trial-banner">
                <lightning-icon icon-name="utility:warning" size="x-small" variant="warning"></lightning-icon>
                <span class="moa-trial-text">
                    Trial expired. Results still visible.
                    Want continuous optimization?
                    <a href="https://marginarc.com" target="_blank" rel="noopener noreferrer">Learn about MarginArc &rarr;</a>
                </span>
            </div>
        </template>

        <!-- Header -->
        <div class="moa-header">
            <div class="moa-header-left">
                <h1 class="moa-title">Margin Opportunity Assessment</h1>
                <template if:true={lastScanLabel}>
                    <p class="moa-subtitle">Last scanned: {lastScanLabel}</p>
                </template>
            </div>
            <div class="moa-header-right">
                <template if:true={hasResult}>
                    <lightning-button
                        label="Export CSV"
                        variant="neutral"
                        onclick={handleExportCsv}
                        class="slds-m-right_small"
                    ></lightning-button>
                </template>
                <lightning-button
                    label={scanButtonLabel}
                    variant="brand"
                    onclick={handleStartScan}
                    disabled={isScanDisabled}
                ></lightning-button>
            </div>
        </div>

        <!-- Error State -->
        <template if:true={error}>
            <div class="moa-card moa-error-card">
                <lightning-icon icon-name="utility:error" variant="error" size="small"></lightning-icon>
                <span class="slds-m-left_small">{error}</span>
            </div>
        </template>

        <!-- Scanning State -->
        <template if:true={isScanning}>
            <div class="moa-card moa-scanning-card">
                <lightning-spinner alternative-text="Scanning..." size="medium"></lightning-spinner>
                <p class="moa-scanning-text">Analyzing your deals... This may take a minute.</p>
            </div>
        </template>

        <!-- Welcome State (no result) -->
        <template if:true={showWelcome}>
            <div class="moa-card moa-welcome-card">
                <lightning-icon icon-name="standard:analytics" size="large"></lightning-icon>
                <h2 class="moa-welcome-title">See How Much Margin You're Leaving on the Table</h2>
                <p class="moa-welcome-desc">
                    MOA scans your historical deals, segments them by OEM, deal size, and customer tier,
                    then quantifies the margin gap. No data leaves Salesforce.
                </p>
                <lightning-button
                    label="Scan Now"
                    variant="brand"
                    onclick={handleStartScan}
                    disabled={isScanDisabled}
                    class="slds-m-top_medium"
                ></lightning-button>
            </div>
        </template>

        <!-- Dashboard (has result) -->
        <template if:true={hasResult}>

            <!-- Section 1: Executive Summary KPI Strip -->
            <div class="moa-card moa-kpi-strip">
                <div class="moa-kpi">
                    <span class="moa-kpi-value">{formattedTotalDeals}</span>
                    <span class="moa-kpi-label">Deals Analyzed</span>
                </div>
                <div class="moa-kpi">
                    <span class="moa-kpi-value">{formattedTotalRevenue}</span>
                    <span class="moa-kpi-label">Total Revenue</span>
                </div>
                <div class="moa-kpi">
                    <span class="moa-kpi-value">{formattedCurrentMargin}</span>
                    <span class="moa-kpi-label">Current Avg Margin</span>
                </div>
                <div class="moa-kpi">
                    <span class="moa-kpi-value moa-kpi-achievable">{formattedAchievableMargin}</span>
                    <span class="moa-kpi-label">Achievable Avg Margin</span>
                </div>
                <div class="moa-kpi moa-kpi-hero">
                    <span class="moa-kpi-value moa-kpi-hero-value">{formattedAnnualOpportunity}</span>
                    <span class="moa-kpi-label">Annual Margin Opportunity</span>
                </div>
            </div>

            <p class="moa-headline">
                Your team is leaving an estimated <strong class="moa-highlight">{formattedAnnualOpportunity}</strong>/year on the table.
            </p>

            <!-- Section 2: Segment Breakdown Table -->
            <div class="moa-card">
                <div class="moa-section-header">
                    <h2 class="moa-section-title">Segment Breakdown</h2>
                    <template if:true={hasMoreCohorts}>
                        <lightning-button
                            label={showAllCohortsLabel}
                            variant="base"
                            onclick={handleToggleCohorts}
                        ></lightning-button>
                    </template>
                </div>
                <div class="moa-table-wrap">
                    <table class="moa-table">
                        <thead>
                            <tr>
                                <th class="moa-th moa-th-sortable" onclick={handleSortCohorts} data-field="segment">
                                    Segment {cohortSortIndicator_segment}
                                </th>
                                <th class="moa-th moa-th-sortable moa-th-right" onclick={handleSortCohorts} data-field="dealCount">
                                    Deals {cohortSortIndicator_dealCount}
                                </th>
                                <th class="moa-th moa-th-sortable moa-th-right" onclick={handleSortCohorts} data-field="winRate">
                                    Win Rate {cohortSortIndicator_winRate}
                                </th>
                                <th class="moa-th moa-th-sortable moa-th-right" onclick={handleSortCohorts} data-field="medianMargin">
                                    Median Margin {cohortSortIndicator_medianMargin}
                                </th>
                                <th class="moa-th moa-th-sortable moa-th-right" onclick={handleSortCohorts} data-field="avgMargin">
                                    Your Avg {cohortSortIndicator_avgMargin}
                                </th>
                                <th class="moa-th moa-th-right">Gap</th>
                                <th class="moa-th moa-th-sortable moa-th-right" onclick={handleSortCohorts} data-field="marginOpportunity">
                                    Opportunity {cohortSortIndicator_marginOpportunity}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <template for:each={displayedCohorts} for:item="cohort">
                                <tr key={cohort.key} class={cohort.rowClass}>
                                    <td class="moa-td">{cohort.segmentLabel}</td>
                                    <td class="moa-td moa-td-right">{cohort.dealCount}</td>
                                    <td class="moa-td moa-td-right">{cohort.winRateFormatted}</td>
                                    <td class="moa-td moa-td-right">{cohort.medianMarginFormatted}</td>
                                    <td class="moa-td moa-td-right">{cohort.avgMarginFormatted}</td>
                                    <td class={cohort.gapClass}>{cohort.gapFormatted}</td>
                                    <td class="moa-td moa-td-right moa-td-bold">{cohort.opportunityFormatted}</td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Section 3: Rep Leaderboard -->
            <template if:true={hasReps}>
                <div class="moa-card">
                    <h2 class="moa-section-title">Rep Leaderboard</h2>
                    <div class="moa-table-wrap">
                        <table class="moa-table">
                            <thead>
                                <tr>
                                    <th class="moa-th">Rep</th>
                                    <th class="moa-th moa-th-right">Deals</th>
                                    <th class="moa-th moa-th-right">Won</th>
                                    <th class="moa-th moa-th-right">Win Rate</th>
                                    <th class="moa-th moa-th-right">Avg Margin</th>
                                    <th class="moa-th moa-th-right">vs Team Avg</th>
                                    <th class="moa-th moa-th-right">Consistency</th>
                                    <th class="moa-th moa-th-right">Opportunity</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template for:each={sortedReps} for:item="rep">
                                    <tr key={rep.repId} class={rep.rowClass}>
                                        <td class="moa-td">{rep.repName}</td>
                                        <td class="moa-td moa-td-right">{rep.dealCount}</td>
                                        <td class="moa-td moa-td-right">{rep.wonCount}</td>
                                        <td class="moa-td moa-td-right">{rep.winRateFormatted}</td>
                                        <td class="moa-td moa-td-right">{rep.avgMarginFormatted}</td>
                                        <td class={rep.vsTeamClass}>{rep.vsTeamFormatted}</td>
                                        <td class="moa-td moa-td-right">{rep.consistencyFormatted}</td>
                                        <td class="moa-td moa-td-right moa-td-bold">{rep.opportunityFormatted}</td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </template>

            <!-- Section 4: Win Rate by Margin Band -->
            <template if:true={hasBands}>
                <div class="moa-card">
                    <h2 class="moa-section-title">Win Rate by Margin Band</h2>
                    <div class="moa-chart">
                        <template for:each={formattedBands} for:item="band">
                            <div key={band.band} class="moa-bar-row">
                                <span class="moa-bar-label">{band.band}</span>
                                <div class="moa-bar-track">
                                    <div class={band.barClass} style={band.barStyle}>
                                        <span class="moa-bar-value">{band.winRateFormatted}</span>
                                    </div>
                                </div>
                                <span class="moa-bar-count">{band.dealCount} deals</span>
                            </div>
                        </template>
                    </div>
                    <template if:true={sweetSpotLabel}>
                        <p class="moa-sweet-spot">Sweet spot: <strong>{sweetSpotLabel}</strong> — highest win rate with 10+ deals</p>
                    </template>
                </div>
            </template>

        </template>

        <!-- Footer -->
        <div class="moa-footer">
            Powered by <a href="https://marginarc.com" target="_blank" rel="noopener noreferrer">MarginArc</a> — AI-powered margin optimization for IT VARs.
            <a href="https://marginarc.com" target="_blank" rel="noopener noreferrer">Learn more &rarr;</a>
        </div>

    </div>
</template>
